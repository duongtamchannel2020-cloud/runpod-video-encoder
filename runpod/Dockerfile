# Multi-stage build for NVENC-compatible FFmpeg
# Stage 1: Get FFmpeg with NVENC support compatible with driver 550.x
FROM jrottenberg/ffmpeg:6.1-nvidia AS ffmpeg

# Stage 2: Runtime with CUDA 12.4 for better compatibility
FROM nvidia/cuda:12.4.1-runtime-ubuntu22.04

# Install essential dependencies
RUN apt-get update && apt-get install -y \
    curl \
    ca-certificates \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Copy FFmpeg binaries with NVENC support (compatible with driver 550.x)
COPY --from=ffmpeg /usr/local/bin/ffmpeg /usr/local/bin/ffmpeg
COPY --from=ffmpeg /usr/local/bin/ffprobe /usr/local/bin/ffprobe

# Set NVIDIA environment for video encoding
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
ENV CUDA_VISIBLE_DEVICES=all
ENV LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}

# Install Node.js 18.x
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install RunPod Python SDK
RUN pip3 install --no-cache-dir runpod

# Verify FFmpeg NVENC support during build
RUN echo "ï¿½ Verifying FFmpeg NVENC compatibility..." \
    && ffmpeg -version | head -3 \
    && echo "ðŸ” Available NVENC encoders:" \
    && (ffmpeg -encoders 2>/dev/null | grep nvenc || echo "âš ï¸ NVENC check will be done at runtime") \
    && echo "âœ… FFmpeg with NVENC support ready for runtime"

# Set working directory
WORKDIR /app

# Copy package.json and install Node.js dependencies
COPY package.json ./
RUN npm ci --only=production

# Copy application files
COPY handler.js runpod_wrapper.py ./

# Create encoding workspace
RUN mkdir -p /tmp/encoding

# Set production environment
ENV NODE_ENV=production

# Create entrypoint script for better startup
RUN echo '#!/bin/bash\n\
echo "ðŸš€ Starting RunPod Video Encoder with NVENC support"\n\
echo "ðŸ”§ GPU: $NVIDIA_VISIBLE_DEVICES"\n\
echo "ðŸ”§ Driver capabilities: $NVIDIA_DRIVER_CAPABILITIES"\n\
echo ""\n\
# Verify NVENC at runtime\n\
echo "ðŸ” Runtime NVENC verification:"\n\
if nvidia-smi -L 2>/dev/null; then\n\
    echo "âœ… NVIDIA GPU detected"\n\
    if ffmpeg -f lavfi -i testsrc=duration=1:size=320x240:rate=1 -c:v h264_nvenc -t 1 -f null - 2>/dev/null; then\n\
        echo "ðŸš€ NVENC WORKING! GPU encoding enabled (6x faster)"\n\
    else\n\
        echo "âš ï¸ NVENC test failed - using CPU encoding (slower but stable)"\n\
    fi\n\
else\n\
    echo "âš ï¸ No NVIDIA GPU detected - using CPU encoding"\n\
fi\n\
echo ""\n\
echo "ðŸŽ¯ Starting RunPod handler..."\n\
exec python3 runpod_wrapper.py\n' > /app/entrypoint.sh \
    && chmod +x /app/entrypoint.sh

# Use entrypoint for better initialization
ENTRYPOINT ["/app/entrypoint.sh"]
